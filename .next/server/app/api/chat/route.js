(()=>{var e={};e.id=276,e.ids=[276],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},14888:(e,t,r)=>{"use strict";r.d(t,{Dv:()=>o,jI:()=>i});var s=r(46010);let n={FREE:["resources","nudges","dashboard_analytics"],PLUS:["resources","nudges","contacts","interactions","sms_nudges","rag_search","dashboard_analytics","upcoming_list"],PREMIUM:["resources","nudges","contacts","interactions","sms_nudges","rag_search","dashboard_analytics","upcoming_list","campaigns_admin"]};async function a(e){let t=await s.z.user.findUnique({where:{id:e}});return t?.plan||"FREE"}async function i(e,t){return n[await a(e)].includes(t)}function o(e){return n[e]}},16698:e=>{"use strict";e.exports=require("node:async_hooks")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},37830:e=>{"use strict";e.exports=require("node:stream/web")},40704:(e,t,r)=>{"use strict";r.d(t,{b1:()=>l,z9:()=>u});var s=r(31630),n=r(46010),a=r(55511);let i=new s.Ay({apiKey:process.env.OPENAI_API_KEY}),o=process.env.EMBEDDING_MODEL||"text-embedding-3-small";async function c(e){return(await i.embeddings.create({model:o,input:e})).data[0].embedding}async function u({title:e,url:t,text:r,meta:s}){let i=(0,a.randomUUID)();await n.z.document.create({data:{id:i,title:e,url:t,meta:s}});let o=function(e,t=1e3){let r=[],s=e.replace(/\r/g,"").split(/\n\n+/),n="";for(let e of s)(n+"\n\n"+e).length>t&&n?(r.push(n.trim()),n=e):n=n?n+"\n\n"+e:e;return n&&r.push(n.trim()),r}(r,1e3);for(let e of o){let t=await c(e),r=Buffer.from(JSON.stringify(t),"utf8");await n.z.chunk.create({data:{documentId:i,content:e,embedding:r}})}return{id:i,chunks:o.length}}async function l(e,t=6){let r=await c(e);return(await n.z.chunk.findMany({include:{document:!0}})).map(e=>{let t=JSON.parse(Buffer.from(e.embedding).toString("utf8"));return{id:e.id,content:e.content,title:e.document.title,url:e.document.url||void 0,similarity:function(e,t){let r=0,s=0,n=0;for(let a=0;a<Math.min(e.length,t.length);a++)r+=e[a]*t[a],s+=e[a]*e[a],n+=t[a]*t[a];return r/(Math.sqrt(s)*Math.sqrt(n)+1e-9)}(r,t)}}).sort((e,t)=>t.similarity-e.similarity).slice(0,t)}},41098:(e,t,r)=>{"use strict";r.d(t,{J:()=>i,Z:()=>o});var s=r(59054),n=r(54119),a=r(46010);async function i(){let{userId:e}=(0,s.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await a.z.user.findUnique({where:{id:e}});if(!t){let r=await (0,n.N)(),s=r?.primaryEmailAddress?.emailAddress||"unknown@example.com";t=await a.z.user.create({data:{id:e,email:s}}),await a.z.profile.create({data:{userId:e}})}return{id:t.id,email:t.email}}async function o(){let{userId:e}=(0,s.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await a.z.user.findUnique({where:{id:e}});if(!t||"ADMIN"!==t.role)throw new Response("Forbidden",{status:403});return{id:t.id,email:t.email}}},41253:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>E,routeModule:()=>f,serverHooks:()=>v,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{POST:()=>w,runtime:()=>g});var n=r(96559),a=r(48088),i=r(37719),o=r(31630),c=r(46010),u=r(41098),l=r(14888),d=r(78297);let p=new o.Ay({apiKey:process.env.OPENAI_API_KEY});async function m(e){if(!process.env.OPENAI_API_KEY)return{};try{let t=await p.chat.completions.create({model:process.env.OPENAI_MODEL||"gpt-4.1-mini",messages:[{role:"user",content:`You will label a short message with principal (GENUINE) and relationship (spouse/partner, friend, manager, colleague, family, client, other). Return JSON only: {"principal":"...", "relationship":"..."}
Message: ${e}`}],temperature:0}),r=t.choices?.[0]?.message?.content||"{}",s=JSON.parse(r.replace(/```json|```/g,""));return{principal:s.principal,relationship:s.relationship}}catch{return{}}}var h=r(40704);let g="nodejs";async function w(e){let t=await (0,u.J)(),r=await e.json(),s=r.messages||[],n=r.conversationId||void 0;if(!await (0,d.UK)(t.id))return new Response("Chat quota reached.",{status:402});let a=await c.z.profile.findUnique({where:{userId:t.id}});if(a?.trackOptIn){n||(n=(await c.z.conversation.create({data:{userId:t.id}})).id);let e=[...s].reverse().find(e=>"user"===e.role);if(e){let t=await c.z.message.create({data:{conversationId:n,role:"user",text:String(e.content).slice(0,4e3)}}),r=Object.entries(await m(String(e.content))).filter(([,e])=>!!e).map(([e,t])=>({key:e,value:String(t)}));r.length&&await c.z.messageTag.createMany({data:r.map(e=>({messageId:t.id,...e}))})}}let i=(s[s.length-1]?.content||"").toString(),p=await (0,l.jI)(t.id,"rag_search"),g=i&&p?await (0,h.b1)(i,6):[],w=g.map((e,t)=>`[${t+1}] ${e.title}${e.url?` (${e.url})`:""}
${e.content}`).join("\n\n"),f=g.length?`

SOURCES:
${g.map((e,t)=>`[${t+1}] ${e.title}${e.url?` (${e.url})`:""}`).join("\n")}`:"",y=new o.Ay({apiKey:process.env.OPENAI_API_KEY}),x=`You are the GENUINEâ„¢ Relationship Coach. Warm, encouraging, non-judgmental. Be concise and actionable. If context sources are provided, cite them inline as [1], [2], etc., and end with a SOURCES list.`,v=await y.chat.completions.create({model:process.env.OPENAI_MODEL||"gpt-4.1",messages:[{role:"system",content:x},...w?[{role:"system",content:`Context (use if relevant):

${w}${f}`}]:[],...s.map(e=>({role:e.role,content:String(e.content)}))]}),E=v.choices?.[0]?.message?.content||"";if(a?.trackOptIn&&n&&E.trim()){let e=await c.z.message.create({data:{conversationId:n,role:"assistant",text:E.slice(0,1e4)}});try{let t=await m(E.slice(0,4e3));t?.principal&&await c.z.messageTag.create({data:{messageId:e.id,key:"principal_reply",value:String(t.principal)}})}catch{}}let q={"Content-Type":"application/json"};return n&&(q["X-Conversation-Id"]=n),new Response(JSON.stringify({text:E}),{status:200,headers:q})}let f=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"/Users/Lizzi/Documents/GitHub/ArchImpacts/app/api/chat/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:x,serverHooks:v}=f;function E(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:x})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46010:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});let s=new(require("@prisma/client")).PrismaClient},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57075:e=>{"use strict";e.exports=require("node:stream")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{"use strict";e.exports=require("node:fs")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78297:(e,t,r)=>{"use strict";r.d(t,{U3:()=>i,UK:()=>a,mY:()=>o});var s=r(46010);let n={FREE:{chatsPerMonth:100,contacts:5,smsPerMonth:0},PLUS:{chatsPerMonth:1e3,contacts:100,smsPerMonth:200},PREMIUM:{chatsPerMonth:5e3,contacts:1e3,smsPerMonth:1e3}};async function a(e){let t=new Date;t.setDate(1),t.setHours(0,0,0,0);let r=await s.z.message.count({where:{conversation:{userId:e},role:"user",createdAt:{gte:t}}}),a=await s.z.user.findUnique({where:{id:e}});return r<n[a?.plan||"FREE"].chatsPerMonth}async function i(e){let t=await s.z.contact.count({where:{userId:e}}),r=await s.z.user.findUnique({where:{id:e}});return t<n[r?.plan||"FREE"].contacts}async function o(e){let t=new Date;t.setDate(1),t.setHours(0,0,0,0);let r=await s.z.nudge.count({where:{creatorId:e,channel:"sms",createdAt:{gte:t}}}),a=await s.z.user.findUnique({where:{id:e}});return r<n[a?.plan||"FREE"].smsPerMonth}},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[719,54,119,676],()=>r(41253));module.exports=s})();
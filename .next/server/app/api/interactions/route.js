(()=>{var e={};e.id=293,e.ids=[293],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4762:(e,t,r)=>{"use strict";async function s(e,t){console.log("SMS ->",e,t)}r.d(t,{q:()=>s})},10651:(e,t,r)=>{"use strict";r.d(t,{M:()=>a});var s=r(41098),n=r(14888);async function a(e){let t=await (0,s.J)();if(!await (0,n.jI)(t.id,e))throw new Response(JSON.stringify({error:"Upgrade required",feature:e}),{status:402});return t}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14888:(e,t,r)=>{"use strict";r.d(t,{Dv:()=>o,jI:()=>i});var s=r(46010);let n={FREE:["resources","nudges","dashboard_analytics"],PLUS:["resources","nudges","contacts","interactions","sms_nudges","rag_search","dashboard_analytics","upcoming_list"],PREMIUM:["resources","nudges","contacts","interactions","sms_nudges","rag_search","dashboard_analytics","upcoming_list","campaigns_admin"]};async function a(e){let t=await s.z.user.findUnique({where:{id:e}});return t?.plan||"FREE"}async function i(e,t){return n[await a(e)].includes(t)}function o(e){return n[e]}},14959:(e,t,r)=>{"use strict";async function s(e,t,r){console.log("Email ->",e,t)}r.d(t,{Z:()=>s})},16698:e=>{"use strict";e.exports=require("node:async_hooks")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},41098:(e,t,r)=>{"use strict";r.d(t,{J:()=>i,Z:()=>o});var s=r(59054),n=r(54119),a=r(46010);async function i(){let{userId:e}=(0,s.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await a.z.user.findUnique({where:{id:e}});if(!t){let r=await (0,n.N)(),s=r?.primaryEmailAddress?.emailAddress||"unknown@example.com";t=await a.z.user.create({data:{id:e,email:s}}),await a.z.profile.create({data:{userId:e}})}return{id:t.id,email:t.email}}async function o(){let{userId:e}=(0,s.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await a.z.user.findUnique({where:{id:e}});if(!t||"ADMIN"!==t.role)throw new Response("Forbidden",{status:403});return{id:t.id,email:t.email}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46010:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});let s=new(require("@prisma/client")).PrismaClient},55511:e=>{"use strict";e.exports=require("crypto")},57686:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>h,runtime:()=>w});var n=r(96559),a=r(48088),i=r(37719),o=r(46010),c=r(10651),u=r(14959),d=r(4762),p=r(14888),l=r(78297);let w="nodejs";async function h(e){let t=await (0,c.M)("interactions"),r=await e.json(),s=String(r.contactId||""),n=String(r.prompt||"").slice(0,1e3),a=new Date(r.scheduledAt||Date.now()),i=await o.z.contact.findFirst({where:{id:s,userId:t.id}});if(!i)return Response.json({error:"Contact not found"},{status:404});let w=await o.z.interaction.create({data:{userId:t.id,contactId:i.id,prompt:n,scheduledAt:a}}),h=Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,10),m=new Date(a.getTime()+6048e5);await o.z.feedbackToken.create({data:{token:h,interactionId:w.id,expiresAt:m}});let f=`${process.env.NEXT_PUBLIC_APP_URL}/f/${h}`,g=`Check-in: ${i.name}`,y=`${n}

Did it happen? Tap to answer: ${f}`,x="sms"===r.channel?"sms":"email";if("sms"===x){if(!await (0,p.jI)(t.id,"sms_nudges"))return Response.json({error:"SMS nudges require Plus"},{status:402});if(!await (0,l.mY)(t.id))return Response.json({error:"Monthly SMS limit reached"},{status:402});await (0,d.q)(i.phone||"",y)}else await (0,u.Z)(i.email||"",g,`<p>${y.replace(/\n/g,"<br/>")}</p>`);let M=await o.z.nudge.create({data:{creatorId:t.id,recipientId:t.id,title:g,message:y,channel:x,scheduledAt:a}});return await o.z.interaction.update({where:{id:w.id},data:{nudgeId:M.id}}),Response.json({interaction:w,nudgeId:M.id,feedbackUrl:f},{status:201})}let m=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/interactions/route",pathname:"/api/interactions",filename:"route",bundlePath:"app/api/interactions/route"},resolvedPagePath:"/Users/Lizzi/Documents/GitHub/ArchImpacts/app/api/interactions/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:g,serverHooks:y}=m;function x(){return(0,i.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:g})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77598:e=>{"use strict";e.exports=require("node:crypto")},78297:(e,t,r)=>{"use strict";r.d(t,{U3:()=>i,UK:()=>a,mY:()=>o});var s=r(46010);let n={FREE:{chatsPerMonth:100,contacts:5,smsPerMonth:0},PLUS:{chatsPerMonth:1e3,contacts:100,smsPerMonth:200},PREMIUM:{chatsPerMonth:5e3,contacts:1e3,smsPerMonth:1e3}};async function a(e){let t=new Date;t.setDate(1),t.setHours(0,0,0,0);let r=await s.z.message.count({where:{conversation:{userId:e},role:"user",createdAt:{gte:t}}}),a=await s.z.user.findUnique({where:{id:e}});return r<n[a?.plan||"FREE"].chatsPerMonth}async function i(e){let t=await s.z.contact.count({where:{userId:e}}),r=await s.z.user.findUnique({where:{id:e}});return t<n[r?.plan||"FREE"].contacts}async function o(e){let t=new Date;t.setDate(1),t.setHours(0,0,0,0);let r=await s.z.nudge.count({where:{creatorId:e,channel:"sms",createdAt:{gte:t}}}),a=await s.z.user.findUnique({where:{id:e}});return r<n[a?.plan||"FREE"].smsPerMonth}},78335:()=>{},96487:()=>{},96559:(e,t,r)=>{"use strict";e.exports=r(44870)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[719,54,119],()=>r(57686));module.exports=s})();
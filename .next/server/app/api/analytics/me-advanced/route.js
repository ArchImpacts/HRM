(()=>{var e={};e.id=202,e.ids=[202],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},16698:e=>{"use strict";e.exports=require("node:async_hooks")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},36878:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>p,serverHooks:()=>g,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{GET:()=>u,runtime:()=>d});var n=r(96559),s=r(48088),i=r(37719),o=r(46010),c=r(41098);let d="nodejs";async function u(){let e=await (0,c.J)(),t=await o.z.profile.findUnique({where:{userId:e.id}});if(!t?.trackOptIn)return Response.json({message:"Tracking disabled"},{status:200});let r=new Date;r.setMonth(r.getMonth()-3);let a=await o.z.interactionFeedback.findMany({where:{interaction:{userId:e.id,createdAt:{gte:r}}},select:{happened:!0,rating:!0,interaction:{select:{contactId:!0}}}}),n=new Map;for(let e of a){let t=e.interaction.contactId,r=n.get(t)||{count:0,happened:0,ratingSum:0};r.count++,e.happened&&r.happened++,r.ratingSum+=e.rating||0,n.set(t,r)}let s=new Map((await o.z.contact.findMany({where:{id:{in:Array.from(n.keys())}}})).map(e=>[e.id,e])),i=Array.from(n.entries()).map(([e,t])=>({id:e,name:s.get(e)?.name||"Unknown",avgRating:t.count?t.ratingSum/t.count:0,completion:t.count?t.happened/t.count:0,interactions:t.count})).sort((e,t)=>t.interactions-e.interactions).slice(0,10),d=await o.z.messageTag.findMany({where:{key:"principal",message:{conversation:{userId:e.id,startedAt:{gte:r}}}},select:{value:!0}}),u=new Map;for(let e of d)u.set(e.value,(u.get(e.value)||0)+1);let p=Array.from(u.entries()).map(([e,t])=>({key:e,value:t})).sort((e,t)=>t.value-e.value),l=await o.z.message.findMany({where:{conversation:{userId:e.id},createdAt:{gte:new Date(new Date().setMonth(new Date().getMonth()-6))},role:"user"},select:{createdAt:!0}}),m=new Map;for(let e of l){let t=e.createdAt.toISOString().slice(0,7);m.set(t,(m.get(t)||0)+1)}let g=Array.from(m.entries()).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>({month:e,count:t})),w={completion:a.length?a.filter(e=>e.happened).length/a.length:0,avgRating:a.length?a.reduce((e,t)=>e+(t.rating||0),0)/a.length:0};return Response.json({overall:w,topContacts:i,principalCounts:p,monthly:g},{status:200})}let p=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/analytics/me-advanced/route",pathname:"/api/analytics/me-advanced",filename:"route",bundlePath:"app/api/analytics/me-advanced/route"},resolvedPagePath:"/Users/Lizzi/Documents/GitHub/ArchImpacts/app/api/analytics/me-advanced/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:l,workUnitAsyncStorage:m,serverHooks:g}=p;function w(){return(0,i.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:m})}},41098:(e,t,r)=>{"use strict";r.d(t,{J:()=>i,Z:()=>o});var a=r(59054),n=r(54119),s=r(46010);async function i(){let{userId:e}=(0,a.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await s.z.user.findUnique({where:{id:e}});if(!t){let r=await (0,n.N)(),a=r?.primaryEmailAddress?.emailAddress||"unknown@example.com";t=await s.z.user.create({data:{id:e,email:a}}),await s.z.profile.create({data:{userId:e}})}return{id:t.id,email:t.email}}async function o(){let{userId:e}=(0,a.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await s.z.user.findUnique({where:{id:e}});if(!t||"ADMIN"!==t.role)throw new Response("Forbidden",{status:403});return{id:t.id,email:t.email}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46010:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});let a=new(require("@prisma/client")).PrismaClient},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},96487:()=>{},96559:(e,t,r)=>{"use strict";e.exports=r(44870)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[719,54,119],()=>r(36878));module.exports=a})();
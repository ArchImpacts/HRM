(()=>{var e={};e.id=83,e.ids=[83],e.modules={4762:(e,t,r)=>{"use strict";async function n(e,t){console.log("SMS ->",e,t)}r.d(t,{q:()=>n})},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14959:(e,t,r)=>{"use strict";async function n(e,t,r){console.log("Email ->",e,t)}r.d(t,{Z:()=>n})},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},42552:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>l,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>p,runtime:()=>c});var s=r(96559),a=r(48088),i=r(37719),u=r(46010),o=r(14959),d=r(4762);let c="nodejs";async function p(){let e=new Date,t=await u.z.nudge.findMany({where:{scheduledAt:{lte:e}},take:50}),r=0;for(let e of t){if(await u.z.nudgeLog.findFirst({where:{nudgeId:e.id,status:"sent"}}))continue;let t=!0;if(e.recipientId){let r=await u.z.profile.findUnique({where:{userId:e.recipientId}});"email"===e.channel&&r&&!r.emailOptIn&&(t=!1),"sms"===e.channel&&r&&!r.smsOptIn&&(t=!1)}try{t?("sms"===e.channel?await (0,d.q)("",e.message):await (0,o.Z)("",e.title||"Nudge",`<p>${e.message.replace(/\n/g,"<br/>")}</p>`),await u.z.nudgeLog.create({data:{nudgeId:e.id,userId:e.recipientId||null,channel:e.channel,status:"sent"}}),r++):await u.z.nudgeLog.create({data:{nudgeId:e.id,userId:e.recipientId||null,channel:e.channel,status:"skipped",error:"opt-out"}})}catch(t){await u.z.nudgeLog.create({data:{nudgeId:e.id,userId:e.recipientId||null,channel:e.channel,status:"error",error:String(t?.message||t)}})}}return new Response(JSON.stringify({ok:!0,sent:r}),{status:200,headers:{"Content-Type":"application/json"}})}let l=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/dispatch/route",pathname:"/api/cron/dispatch",filename:"route",bundlePath:"app/api/cron/dispatch/route"},resolvedPagePath:"/Users/Lizzi/Documents/GitHub/ArchImpacts/app/api/cron/dispatch/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:g,workUnitAsyncStorage:h,serverHooks:m}=l;function w(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:h})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46010:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});let n=new(require("@prisma/client")).PrismaClient},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{},96559:(e,t,r)=>{"use strict";e.exports=r(44870)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[719],()=>r(42552));module.exports=n})();
(()=>{var e={};e.id=310,e.ids=[310],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},16698:e=>{"use strict";e.exports=require("node:async_hooks")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},36466:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>p,serverHooks:()=>x,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>c,runtime:()=>d});var i=r(96559),n=r(48088),a=r(37719),u=r(41098),o=r(40704);let d="nodejs";async function c(e){await (0,u.Z)();let t=await e.json(),r=Array.isArray(t?.docs)?t.docs:[t],s=0;for(let e of r)e?.title&&e?.text&&(await (0,o.z9)({title:String(e.title),url:e.url?String(e.url):void 0,text:String(e.text),meta:e.meta||void 0}),s++);return Response.json({ok:!0,ingested:s},{status:200})}let p=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/corpus/upload/route",pathname:"/api/admin/corpus/upload",filename:"route",bundlePath:"app/api/admin/corpus/upload/route"},resolvedPagePath:"/Users/Lizzi/Documents/GitHub/ArchImpacts/app/api/admin/corpus/upload/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:m,serverHooks:x}=p;function f(){return(0,a.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:m})}},37830:e=>{"use strict";e.exports=require("node:stream/web")},40704:(e,t,r)=>{"use strict";r.d(t,{b1:()=>c,z9:()=>d});var s=r(31630),i=r(46010),n=r(55511);let a=new s.Ay({apiKey:process.env.OPENAI_API_KEY}),u=process.env.EMBEDDING_MODEL||"text-embedding-3-small";async function o(e){return(await a.embeddings.create({model:u,input:e})).data[0].embedding}async function d({title:e,url:t,text:r,meta:s}){let a=(0,n.randomUUID)();await i.z.document.create({data:{id:a,title:e,url:t,meta:s}});let u=function(e,t=1e3){let r=[],s=e.replace(/\r/g,"").split(/\n\n+/),i="";for(let e of s)(i+"\n\n"+e).length>t&&i?(r.push(i.trim()),i=e):i=i?i+"\n\n"+e:e;return i&&r.push(i.trim()),r}(r,1e3);for(let e of u){let t=await o(e),r=Buffer.from(JSON.stringify(t),"utf8");await i.z.chunk.create({data:{documentId:a,content:e,embedding:r}})}return{id:a,chunks:u.length}}async function c(e,t=6){let r=await o(e);return(await i.z.chunk.findMany({include:{document:!0}})).map(e=>{let t=JSON.parse(Buffer.from(e.embedding).toString("utf8"));return{id:e.id,content:e.content,title:e.document.title,url:e.document.url||void 0,similarity:function(e,t){let r=0,s=0,i=0;for(let n=0;n<Math.min(e.length,t.length);n++)r+=e[n]*t[n],s+=e[n]*e[n],i+=t[n]*t[n];return r/(Math.sqrt(s)*Math.sqrt(i)+1e-9)}(r,t)}}).sort((e,t)=>t.similarity-e.similarity).slice(0,t)}},41098:(e,t,r)=>{"use strict";r.d(t,{J:()=>a,Z:()=>u});var s=r(59054),i=r(54119),n=r(46010);async function a(){let{userId:e}=(0,s.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await n.z.user.findUnique({where:{id:e}});if(!t){let r=await (0,i.N)(),s=r?.primaryEmailAddress?.emailAddress||"unknown@example.com";t=await n.z.user.create({data:{id:e,email:s}}),await n.z.profile.create({data:{userId:e}})}return{id:t.id,email:t.email}}async function u(){let{userId:e}=(0,s.j)();if(!e)throw new Response("Unauthorized",{status:401});let t=await n.z.user.findUnique({where:{id:e}});if(!t||"ADMIN"!==t.role)throw new Response("Forbidden",{status:403});return{id:t.id,email:t.email}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46010:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});let s=new(require("@prisma/client")).PrismaClient},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57075:e=>{"use strict";e.exports=require("node:stream")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{"use strict";e.exports=require("node:fs")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},96487:()=>{}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[719,54,119,676],()=>r(36466));module.exports=s})();